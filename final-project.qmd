---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(stats)
```

Trying to understand what influences the distribution of microplastics. Does microplstic distribution/density change over time.

Who's at most risk for microplastic?
N0: there is no correlation between micrplastic location and 


initlai notebook that shows fi my data agrees taht there are more microplastics over time

then we can move to spatail informations

```{r}
pop <- read_csv(here("data/nagdc-population-landscape-and-climate-estimates-version-3.csv"))

pop <- pop %>% 
  filter(VARIABLEID==17)
```

```{r}
mp <- read_csv(here("data/Marine_Microplastics_NOAA.csv"))
```

```{r}
# pieces/m3
mp <- mp %>% 
  mutate(Year = year(mdy_hms(mp$Date))) %>%
  mutate(Date = mdy_hms(mp$Date)) %>% 
  filter(Unit=="pieces/m3") %>%
  select(c("Oceans", "Regions", "Measurement",
           "Latitude", "Longitude", "Date", "Year")) %>%  
  filter(Year %in% 2000:2020) %>% 
  filter(Oceans!="Arctic Ocean") %>% 
  mutate(Oceans=as.factor(Oceans)) %>% 
  clean_names()
```


```{r}
ggplot(mp, aes(x=longitude, y=latitude, fill = oceans,
               alpha = measurement)) +
  geom_point(shape=21)
```

```{r}
# Fit the model
model <- lm(measurement ~ year, data = mp)

# Summarize the results
summary(model)
```

```{r}
# Fit the model
model <- lm(measurement ~ oceans, data = mp)

# Summarize the results
summary(model)
```
## Data Distribution

```{r}
ggplot(mp, aes(measurement)) +
  geom_histogram(aes(fill=oceans)) +
  facet_wrap(~oceans)
```

```{r}
qqnorm(residuals(model), pch = 1, frame = FALSE)
qqline(residuals(model), col = "red")
```

Fix it maybe log?

### Log Transformation


```{r}
 mp <- mp %>% 
   filter(measurement > 0) %>% 
   mutate(measurement_log = log(measurement)) 
```


```{r}
ggplot(mp, aes(measurement_log)) +
  geom_histogram(aes(fill=oceans)) +
  facet_wrap(~oceans)
```

```{r}
qqnorm(mp$measurement_log, pch = 1, frame = FALSE)
qqline(mp$measurement_log, col = "red")
```


lm model the log-transformed measurements

```{r}
acf_lm <- lm(measurement_log ~ date, data = mp)
```

Residual Plot

```{r}
resids <- acf_lm$residuals
fitted_vals <- fitted(acf_lm)
resid_plot <- tibble(resids, fitted_vals)

ggplot(resid_plot, aes(fitted_vals, resids)) +
  geom_point() +
  geom_hline(yintercept = 0)
```

ACF Plot
```{r}
residual_acf <- acf(resid(acf_lm), plot = FALSE)
tibble(Lag = residual_acf$lag, ACF = as.vector(residual_acf$acf)) %>% 
  ggplot(aes(Lag, ACF)) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", 
             color = "cornflowerblue",
             linewidth = 1.5) +
  geom_line(linewidth = 2)

```

Our data is i.i.d. residuals do not have autocorrelation.

```{r}
plastic_mlm <- lm(measurement_log ~ date + latitude + longitude, data = mp)
summary(plastic_mlm)

oceans_glm <- glm(measurement_log ~ oceans, data = mp)
summary(oceans_glm)
```

The log-transformed microplastic levels differ significantly between some oceans (e.g., Atlantic) and the reference ocean.

The Pacific Ocean is not significantly different from the reference, meaning their mean log-transformed microplastic levels are similar.

```{r}
ggplot(mp, aes(oceans, measurement_log)) +
  geom_boxplot(aes(fill=oceans))
```

```{r}
ggplot(mp, aes(date, measurement_log)) +
  geom_point() +
  geom_smooth(method="lm")
```

```{r}
ggplot(mp, aes(latitude, measurement_log)) +
  geom_point() +
  geom_smooth(method="lm")
```
No correlation

```{r}
ggplot(mp, aes(longitude, measurement_log)) +
  geom_point() +
  geom_smooth(method="lm")
```


No need for interactioncs

```{r}
lm_model <- lm(measurement_log ~ oceans + date, data = mp)
summary(lm_model)
```

Plot residuals

```{r}
resids <- lm_model$residuals
fitted_vals <- fitted(lm_model)
resid_plot <- tibble(resids, fitted_vals)

ggplot(resid_plot, aes(fitted_vals, resids)) +
  geom_point() +
  geom_hline(yintercept = 0)
```


 Use interaction term to check w/ differences in oceans. maybe i seperate the data by ocean 
 
```{r}
pacific_atlantic <- mp %>% 
  filter(oceans %in% (c("Pacific Ocean", "Atlantic Ocean")))
```
 
```{r}
lm_model <- lm(measurement_log ~ oceans*date, data = pacific_atlantic)
summary(lm_model)
```

Plot residuals

```{r}
resids <- lm_model$residuals
fitted_vals <- fitted(lm_model)
resid_plot <- tibble(resids, fitted_vals)

ggplot(resid_plot, aes(fitted_vals, resids)) +
  geom_point() +
  geom_hline(yintercept = 0)
```

ACF Plot
```{r}
residual_acf <- acf(resid(lm_model), plot = FALSE)
tibble(Lag = residual_acf$lag, ACF = as.vector(residual_acf$acf)) %>% 
  ggplot(aes(Lag, ACF)) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", 
             color = "cornflowerblue",
             linewidth = 1.5) +
  geom_line(linewidth = 2)

```

```{r}
ggplot(mp, aes(x = year, y = measurement_log, color = oceans)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Plastic Density by Year",
       x = "Year", y = "Microplastic Density in log(pieces/m3)")
```


# REDO
```{r}
pacifc_ts <- mp$measurement[mp$oceans == "Pacific Ocean"] # convert it to a time series
pacifc_ts <- ts(pacifc_ts, start=min(mp$year), end=max(mp$year)) 
pacifc_ts
```
 
```{r}
plot(pacifc_ts, ylab="Microplastic Density", xlab="Year")
```

```{r}
acf(pacifc_ts)
pacf(pacifc_ts)
```
 
```{r}
library(forecast)
ndiffs(x=pacifc_ts)
```

```{r}
plot(diff(pacifc_ts, 10))
```
 
```{r}
pacifc_ts_Best <- auto.arima(x=pacifc_ts)
pacifc_ts_Best
```
 

```{r}
library(ggpubr)
ggqqplot(mp$measurement_log)

```
 
 